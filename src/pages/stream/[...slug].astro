---
import { getCollection, render } from "astro:content";
import Layout from "../../components/Layout.astro";
import { dateOptions, parseDateFromId } from "../../utils/types";
import { getImageAspectRatio } from "../../utils/getImageAspectRatios";
import clsx from "clsx";

export async function getStaticPaths() {
  const stream = await getCollection("stream");
  return stream.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const photo = post.data.photo
  ? await getImageAspectRatio(post.data.photo)
  : null;
---

<Layout
  title={`Stream - ${parseDateFromId(post.id).toLocaleDateString("en-GB", dateOptions)}`}
>
  <article class="grid grid-cols-subgrid lg:col-span-11 gap-8">
    <div
      class={clsx({
        "lg:order-2 lg:col-span-4": !photo || photo.aspectRatio < 1,
        "lg:col-span-10 lg:col-start-2": photo && photo.aspectRatio > 1,
      })}
    >
      <header>
        <h1 class="text-4xl font-semibold text-balance">
          {parseDateFromId(post.id).toLocaleDateString("en-GB", dateOptions)}
        </h1>
        {post.data.camera && <h5 class="text-white/70">{post.data.camera}</h5>}
        <div class="prose text-lg lg:text-xl text-pretty mt-8">
          <Content />
        </div>
      </header>
    </div>
    {
      photo && (
        <figure
          class={clsx({
            "lg:order-1 lg:col-start-2 lg:col-span-5": photo.aspectRatio < 1,
            "lg:col-span-10 col-start-2": photo.aspectRatio > 1,
          })}
        >
          <img
            src={`https://imagedelivery.net/tfgleCjJafHVtd2F4ngDnQ/${photo.cloudflareId}/large`}
            alt=""
            class="border-4 rounded-xs"
          />
        </figure>
      )
    }
  </article>
</Layout>
